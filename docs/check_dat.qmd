---
title: "Data checking"
author: "Nguyen Thi Duyen"
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontsize: 12pt
format:
  html:
    theme: cosmo
    toc: true
    toc-depth: 2
    number-sections: true
    smooth-scroll: true
    standalone: true
    embed-resources: true
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = TRUE, message = TRUE)
knitr::opts_knit$set(root.dir = here::here())
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  cache = FALSE,
  fig.align = "center",
  fig.show = "hold"
)

```

```{r include=FALSE}
library(tidyverse)
library(here)
library(targets)
library(knitr)
options(width=200)
```

# Read in data

```{r}
tmp <- tar_manifest()

tmp |>
  filter(str_detect(name, "summary")) |>
  filter(str_detect(name, "wd"))

tallo_wd_df <- tar_read(tallo_wd_df)
tallo_wd_df
summary(tallo_wd_df)
count_sp <- tallo_wd_df |>
  group_by(sp) |>
  summarise(count = n()
)
count_sp


```

# Overlapping data
```{r}
tallo_wd_df0 <- tar_read(tallo_wd_df0)
tallo_wd_df0
count_sp0 <- tallo_wd_df0 |>
  group_by(sp) |>
  summarise(count = n()
)
count_sp0


```

- 355,881 trees
- 2,961 sp

# H data

```{r}
tallo_reduced_lr_df_ang_h <- tar_read(tallo_reduced_lr_df_ang_h)
tallo_reduced_lr_df_ang_h

ang_data_h <- tallo_reduced_lr_df_ang_h |> filter(division == "Angiosperm") |>
  group_by(sp) |>
  summarise(count = n()) |>
  filter(count >= 20)

ang_h_sp

gym_data_h <- tallo_reduced_lr_df_ang_h |> filter(division == "Gymnosperm") |>
  group_by(sp) |>
  summarise(count = n()) |>
  filter(count >= 20)
gym_h_sp


stan_data_lr_ang_h <- tar_read(stan_data_lr_ang_h)
str(stan_data_lr_ang_h)

stan_data_lr_gym_h <- tar_read(stan_data_lr_gym_h)
str(stan_data_lr_gym_h)

```

# CR data

```{r}
tallo_reduced_lr_df_ang_cr <- tar_read(tallo_reduced_lr_df_ang_cr)
tallo_reduced_lr_df_ang_cr
cr_sp <- tallo_reduced_lr_df_ang_cr |>
  group_by(sp) |>
  summarise(count = n()) |>
  filter(count >= 20)
cr_sp


ang_data_cr <- tallo_reduced_lr_df_ang_cr |> filter(division == "Angiosperm")
ang_data_cr
ang_cr_sp <- ang_data_cr |>
  group_by(sp) |>
  summarise(count = n()) |>
  filter(count >= 20)
ang_cr_sp

gym_data_cr <- tallo_reduced_lr_df_ang_cr |> filter(division == "Gymnosperm")
gym_data_cr
gym_cr_sp <- gym_data_cr |>
  group_by(sp) |>
  summarise(count = n()) |>
  filter(count >= 20)
gym_cr_sp


stan_data_lr_ang_cr <- tar_read(stan_data_lr_ang_cr)
str(stan_data_lr_ang_cr)

stan_data_lr_gym_cr <- tar_read(stan_data_lr_gym_cr)
str(stan_data_lr_gym_cr)

```

# DBH data

```{r}
tallo_reduced_lr_df_ang_dbh <- tar_read(tallo_reduced_lr_df_ang_dbh)
tallo_reduced_lr_df_ang_dbh
dbh_sp <- tallo_reduced_lr_df_ang_dbh |>
  group_by(sp) |>
  summarise(count = n()) |>
  filter(count >= 20)
dbh_sp


ang_data_dbh <- tallo_reduced_lr_df_ang_dbh |> filter(division == "Angiosperm")
ang_data_dbh

ang_dbh_data <- ang_data_dbh |> filter(!is.na(dbh), !is.na(cr), !is.na(h)) |> group_by(sp)

ang_dbh_sp <- ang_dbh_data |>
  group_by(sp) |>
  summarise(count = n()) |>
  filter(count >= 20)
ang_dbh_sp

# 744

gym_data_dbh <- tallo_reduced_lr_df_ang_dbh |> filter(division == "Gymnosperm")
gym_data_dbh

gym_dbh_data <- gym_data_dbh |> filter(!is.na(dbh), !is.na(cr), !is.na(h)) |> group_by(sp)

gym_dbh_sp
gym_dbh_sp <- gym_dbh_data |>
  group_by(sp) |>
  summarise(count = n()) |>
  filter(count >= 20)
gym_dbh_sp

#56
#now it ok

stan_data_lr_ang_dbh <- tar_read(stan_data_lr_ang_dbh)
str(stan_data_lr_ang_dbh)

stan_data_lr_gym_dbh <- tar_read(stan_data_lr_gym_dbh)
str(stan_data_lr_gym_dbh)


# tallo_wd_df0 <- tar_read(tallo_wd_df0)
# tallo_wd_df0

# dbh_data <- tallo_wd_df0 |> filter(!is.na(dbh), !is.na(cr), !is.na(h)) |> group_by(sp) |> filter(n() >= 20) |> ungroup()
# dbh_data

# dbh_sp <- dbh_data |>
#   group_by(sp) |>
#   summarise(count = n())

# dbh_sp
# Load the tallo_reduced_lr_df for DBH1 data processing
tallo_reduced_lr_df_ang_dbh1 <- tar_read(tallo_reduced_lr_df_ang_dbh1)
tallo_reduced_lr_df_ang_dbh1

# Summarise species count for Angiosperms with DBH1 data
dbh1_sp <- tallo_reduced_lr_df_ang_dbh1 |>
  group_by(sp) |>
  summarise(count = n()) |>
  filter(count >= 20)
dbh1_sp

# Filter Angiosperm data with DBH1
ang_data_dbh1 <- tallo_reduced_lr_df_ang_dbh1 |> filter(division == "Angiosperm")
ang_data_dbh1

# Filter and clean the DBH1 data for Angiosperms
ang_dbh1_data <- ang_data_dbh1 |> filter(!is.na(dbh), !is.na(cr), !is.na(h)) |> group_by(sp)

# Summarise species with enough samples (>= 20) for Angiosperms
ang_dbh1_sp <- ang_dbh1_data |>
  group_by(sp) |>
  summarise(count = n()) |>
  filter(count >= 20)
ang_dbh1_sp

# Gymnosperm data processing for DBH1
gym_data_dbh1 <- tallo_reduced_lr_df_ang_dbh1 |> filter(division == "Gymnosperm")
gym_data_dbh1

# Filter and clean the DBH1 data for Gymnosperms
gym_dbh1_data <- gym_data_dbh1 |> filter(!is.na(dbh), !is.na(cr), !is.na(h)) |> group_by(sp)

# Summarise species with enough samples (>= 20) for Gymnosperms
gym_dbh1_sp <- gym_dbh1_data |>
  group_by(sp) |>
  summarise(count = n()) |>
  filter(count >= 20)
gym_dbh1_sp

# Load Stan data for DBH1 for Angiosperms and Gymnosperms
stan_data_lr_ang_dbh1 <- tar_read(stan_data_lr_ang_dbh1)
str(stan_data_lr_ang_dbh1)

ang_data_dbh1 <- tallo_reduced_lr_df_ang_dbh1 |>
    filter(division == "Angiosperm", !is.na(dbh), !is.na(cr), !is.na(h)) |>
    group_by(sp) |> filter(n() >= 20) |>
    ungroup()
 
stan_data_lr_gym_dbh1 <- tar_read(stan_data_lr_gym_dbh1)
str(stan_data_lr_gym_dbh1)


stan_data_lr_ang_dbh2 <- tar_read(stan_data_lr_ang_dbh2)
str(stan_data_lr_ang_dbh2)

stan_data_lr_gym_dbh2 <- tar_read(stan_data_lr_gym_dbh2)
str(stan_data_lr_gym_dbh2)

  ang_data_dbh2 <- tallo_reduced_lr_df_ang_dbh2 |>
    filter(division == "Angiosperm", !is.na(dbh), !is.na(cr), !is.na(h)) |>
    group_by(sp) |> filter(n() >= 20) |>
    ungroup()

stan_data_lr_ang_dbh3 <- tar_read(stan_data_lr_ang_dbh3)
str(stan_data_lr_ang_dbh3)

stan_data_lr_gym_dbh3 <- tar_read(stan_data_lr_gym_dbh3)
str(stan_data_lr_gym_dbh3)


stan_data_lr_ang_dbh <- tar_read(stan_data_lr_ang_dbh)
str(stan_data_lr_ang_dbh)

stan_data_lr_gym_dbh <- tar_read(stan_data_lr_gym_dbh)
str(stan_data_lr_gym_dbh)


```


# Characteristics of dataset and sub-datasets

```{r}
# Dataset
# d0 <- tar_read(tallo_wd_df0)
# ori_sample_size <- nrow(d0)
# ori_species_number <- d0 |>
#   distinct(sp) |>
#   nrow()

# H allometry sub dataset
tallo_reduced_lr_df_ang_h <- tar_read(tallo_reduced_lr_df_ang_h)
tallo_reduced_lr_df_ang_h

ang_data_h <- tallo_reduced_lr_df_ang_h |> filter(division == "Angiosperm")

ang_h_obs <- nrow(ang_data_h)
ang_h_sp <- ang_data_h |>
  distinct(sp) |>
  nrow()

ang_h_trait_ranges <- ang_data_h |>
    dplyr::select(dbh, h, wd) |>
    apply(2, range)

gym_data_h <- tallo_reduced_lr_df_ang_h |> filter(division == "Gymnosperm")

gym_h_obs <- nrow(gym_data_h)
gym_h_sp <- gym_data_h |>
  distinct(sp) |>
  nrow()

gym_h_trait_ranges <- gym_data_h |>
    dplyr::select(dbh, h, wd) |>
    apply(2, range)


# CR allometry sub dataset
tallo_reduced_lr_df_ang_cr <- tar_read(tallo_reduced_lr_df_ang_cr)
tallo_reduced_lr_df_ang_cr

ang_data_cr <- tallo_reduced_lr_df_ang_cr |> filter(division == "Angiosperm")
ang_cr_obs <- nrow(ang_data_cr)
ang_cr_sp <- ang_data_cr |>
  distinct(sp) |>
  nrow()
ang_cr_trait_ranges <- ang_data_cr |>
  dplyr::select(dbh, cr, wd) |>
  apply(2, range)

gym_data_cr <- tallo_reduced_lr_df_ang_cr |> filter(division == "Gymnosperm")
gym_cr_obs <- nrow(gym_data_cr)
gym_cr_sp <- gym_data_cr |>
  distinct(sp) |>
  nrow()
gym_cr_trait_ranges <- gym_data_cr |>
  dplyr::select(dbh, cr, wd) |>
  apply(2, range)


# DBH allometry sub dataset
tallo_reduced_lr_df_ang_dbh <- tar_read(tallo_reduced_lr_df_ang_dbh)

# Angiosperm data
ang_data_dbh <- tallo_reduced_lr_df_ang_dbh |> 
  filter(division == "Angiosperm", 
         !is.na(dbh), 
         !is.na(cr), 
         !is.na(h)) |> 
  group_by(sp) |> 
  filter(n() >= 20) |>
  ungroup()

ang_dbh_obs <- nrow(ang_data_dbh)
ang_dbh_sp <- ang_data_dbh |> 
  distinct(sp) |> 
  nrow()
ang_dbh_trait_ranges <- ang_data_dbh |> 
  dplyr::select(dbh, cr, h, wd) |> 
  apply(2, range)

# Gymnosperm data
gym_data_dbh <- tallo_reduced_lr_df_ang_dbh |> 
  filter(division == "Gymnosperm", 
         !is.na(dbh), 
         !is.na(cr), 
         !is.na(h)) |> 
  group_by(sp) |> 
  filter(n() >= 20) |>
  ungroup()

gym_dbh_obs <- nrow(gym_data_dbh)
gym_dbh_sp <- gym_data_dbh |> 
  distinct(sp) |> 
  nrow()
gym_dbh_trait_ranges <- gym_data_dbh |> 
  dplyr::select(dbh, cr, h, wd) |> 
  apply(2, range)


```

## TableS1
```{r}
library(dplyr)
library(tidyr)

combined_data <- tibble(
  `Dependent variables` = rep(c("H", "CR", "DBH"), each = 2),
  Division = rep(c("Angiosperm", "Gymnosperm"), times = 3),
  `Number of trees` = c(
    nrow(ang_data_h), nrow(gym_data_h),
    nrow(ang_data_cr), nrow(gym_data_cr),
    nrow(ang_data_dbh), nrow(gym_data_dbh)
  ),
  `Number of species` = c(
    ang_data_h |> distinct(sp) |> nrow(),
    gym_data_h |> distinct(sp) |> nrow(),
    ang_data_cr |> distinct(sp) |> nrow(),
    gym_data_cr |> distinct(sp) |> nrow(),
    ang_data_dbh |> distinct(sp) |> nrow(),
    gym_data_dbh |> distinct(sp) |> nrow()
  ),
  `DBH range` = c(
    paste0(round(min(ang_data_h$dbh), 2), " - ", round(max(ang_data_h$dbh), 2)),
    paste0(round(min(gym_data_h$dbh), 2), " - ", round(max(gym_data_h$dbh), 2)),
    paste0(round(min(ang_data_cr$dbh), 2), " - ", round(max(ang_data_cr$dbh), 2)),
    paste0(round(min(gym_data_cr$dbh), 2), " - ", round(max(gym_data_cr$dbh), 2)),
    paste0(round(min(ang_data_dbh$dbh), 2), " - ", round(max(ang_data_dbh$dbh), 2)),
    paste0(round(min(gym_data_dbh$dbh), 2), " - ", round(max(gym_data_dbh$dbh), 2))
  ),
  `Dependent variable range` = c(
    paste0(round(min(ang_data_h$h), 2), " - ", round(max(ang_data_h$h), 2)),
    paste0(round(min(gym_data_h$h), 2), " - ", round(max(gym_data_h$h), 2)),
    paste0(round(min(ang_data_cr$cr), 2), " - ", round(max(ang_data_cr$cr), 2)),
    paste0(round(min(gym_data_cr$cr), 2), " - ", round(max(gym_data_cr$cr), 2)),
    paste0(round(min(ang_data_dbh$cr), 2), " - ", round(max(ang_data_dbh$cr), 2)),
    paste0(round(min(gym_data_dbh$cr), 2), " - ", round(max(gym_data_dbh$cr), 2))
  ),
  `WD range` = c(
    paste0(round(min(ang_data_h$wd), 3), " - ", round(max(ang_data_h$wd), 3)),
    paste0(round(min(gym_data_h$wd), 3), " - ", round(max(gym_data_h$wd), 3)),
    paste0(round(min(ang_data_cr$wd), 3), " - ", round(max(ang_data_cr$wd), 3)),
    paste0(round(min(gym_data_cr$wd), 3), " - ", round(max(gym_data_cr$wd), 3)),
    paste0(round(min(ang_data_dbh$wd), 3), " - ", round(max(ang_data_dbh$wd), 3)),
    paste0(round(min(gym_data_dbh$wd), 3), " - ", round(max(gym_data_dbh$wd), 3))
  ),
  Relationship = c(
    "H-DBH", "H-DBH",
    "CR-DBH", "CR-DBH",
    "DBH-CR,H", "DBH-CR,H"
  )
)

combined_data

combined_data_fixed <- combined_data |>
  mutate(across(c(`Number of trees`, `Number of species`, `DBH range`, `Dependent variable range`, `WD range`), as.character))

formatted_table <- combined_data_fixed |>
  pivot_longer(
    cols = c(`Number of trees`, `Number of species`, `DBH range`, `Dependent variable range`, `WD range`),
    names_to = "Characteristics",
    values_to = "Values"
  ) |>
  pivot_wider(
    names_from = Division,
    values_from = Values
  ) |>
  dplyr::select(`Dependent variables`, Characteristics, Relationship, Angiosperm, Gymnosperm)

formatted_table

```

```{r}
library(targets)
library(dplyr)
library(tidyr)

# Read and process H allometry sub-dataset
tallo_reduced_lr_df_ang_h <- tar_read(tallo_reduced_lr_df_ang_h)

ang_data_h <- tallo_reduced_lr_df_ang_h |> filter(division == "Angiosperm")
gym_data_h <- tallo_reduced_lr_df_ang_h |> filter(division == "Gymnosperm")

ang_h_obs <- nrow(ang_data_h)
ang_h_sp <- ang_data_h |> distinct(sp) |> nrow()
ang_h_trait_ranges <- ang_data_h |> dplyr::select(dbh, h, wd) |> apply(2, range)

gym_h_obs <- nrow(gym_data_h)
gym_h_sp <- gym_data_h |> distinct(sp) |> nrow()
gym_h_trait_ranges <- gym_data_h |> dplyr::select(dbh, h, wd) |> apply(2, range)

# Read and process CR allometry sub-dataset
tallo_reduced_lr_df_ang_cr <- tar_read(tallo_reduced_lr_df_ang_cr)

ang_data_cr <- tallo_reduced_lr_df_ang_cr |> filter(division == "Angiosperm")
gym_data_cr <- tallo_reduced_lr_df_ang_cr |> filter(division == "Gymnosperm")

ang_cr_obs <- nrow(ang_data_cr)
ang_cr_sp <- ang_data_cr |> distinct(sp) |> nrow()
ang_cr_trait_ranges <- ang_data_cr |> dplyr::select(dbh, cr, wd) |> apply(2, range)

gym_cr_obs <- nrow(gym_data_cr)
gym_cr_sp <- gym_data_cr |> distinct(sp) |> nrow()
gym_cr_trait_ranges <- gym_data_cr |> dplyr::select(dbh, cr, wd) |> apply(2, range)

# Read and process DBH allometry sub-dataset
tallo_reduced_lr_df_ang_dbh <- tar_read(tallo_reduced_lr_df_ang_dbh)

ang_data_dbh <- tallo_reduced_lr_df_ang_dbh |>
  filter(division == "Angiosperm", !is.na(dbh), !is.na(cr), !is.na(h)) |>
  group_by(sp) |>
  filter(n() >= 20) |>
  ungroup()

gym_data_dbh <- tallo_reduced_lr_df_ang_dbh |>
  filter(division == "Gymnosperm", !is.na(dbh), !is.na(cr), !is.na(h)) |>
  group_by(sp) |>
  filter(n() >= 20) |>
  ungroup()

ang_dbh_obs <- nrow(ang_data_dbh)
ang_dbh_sp <- ang_data_dbh |> distinct(sp) |> nrow()
ang_dbh_trait_ranges <- ang_data_dbh |> dplyr::select(dbh, cr, h, wd) |> apply(2, range)

gym_dbh_obs <- nrow(gym_data_dbh)
gym_dbh_sp <- gym_data_dbh |> distinct(sp) |> nrow()
gym_dbh_trait_ranges <- gym_data_dbh |> dplyr::select(dbh, cr, h, wd) |> apply(2, range)

# Combine the data
combined_data <- tibble(
  `Dependent variables` = rep(c("H", "CR", "DBH"), each = 2),
  Division = rep(c("Angiosperm", "Gymnosperm"), times = 3),
  `Number of trees` = as.character(c(
    nrow(ang_data_h), nrow(gym_data_h),
    nrow(ang_data_cr), nrow(gym_data_cr),
    nrow(ang_data_dbh), nrow(gym_data_dbh)
  )),
  `Number of species` = as.character(c(
    ang_data_h |> distinct(sp) |> nrow(),
    gym_data_h |> distinct(sp) |> nrow(),
    ang_data_cr |> distinct(sp) |> nrow(),
    gym_data_cr |> distinct(sp) |> nrow(),
    ang_data_dbh |> distinct(sp) |> nrow(),
    gym_data_dbh |> distinct(sp) |> nrow()
  )),
  `DBH range` = c(
    range(ang_data_h$dbh) |> paste(collapse = " - "), range(gym_data_h$dbh) |> paste(collapse = " - "),
    range(ang_data_cr$dbh) |> paste(collapse = " - "), range(gym_data_cr$dbh) |> paste(collapse = " - "),
    range(ang_data_dbh$dbh) |> paste(collapse = " - "), range(gym_data_dbh$dbh) |> paste(collapse = " - ")
  ),
  `Dependent variable range` = c(
    range(ang_data_h$h) |> paste(collapse = " - "), range(gym_data_h$h) |> paste(collapse = " - "),
    range(ang_data_cr$cr) |> paste(collapse = " - "), range(gym_data_cr$cr) |> paste(collapse = " - "),
    range(ang_data_dbh$cr) |> paste(collapse = " - "), range(gym_data_dbh$cr) |> paste(collapse = " - ")
  ),
  `WD range` = c(
    range(ang_data_h$wd) |> paste(collapse = " - "), range(gym_data_h$wd) |> paste(collapse = " - "),
    range(ang_data_cr$wd) |> paste(collapse = " - "), range(gym_data_cr$wd) |> paste(collapse = " - "),
    range(ang_data_dbh$wd) |> paste(collapse = " - "), range(gym_data_dbh$wd) |> paste(collapse = " - ")
  ),
  Relationship = rep(c("H-DBH", "CR-DBH", "DBH-CR,H"), each = 2)
)

formatted_table <- combined_data |>
  pivot_longer(
    cols = c(`Number of trees`, `Number of species`, `DBH range`, `Dependent variable range`, `WD range`),
    names_to = "Characteristics",
    values_to = "Values"
  ) |>
  pivot_wider(
    names_from = Division,
    values_from = Values
  ) |>
  dplyr::select(`Dependent variables`, Characteristics, Relationship, Angiosperm, Gymnosperm)

formatted_table
```

# Take 3 digits for WD

```{r}
library(dplyr)
library(tidyr)
library(targets)

# Read and process H allometry sub-dataset
tallo_reduced_lr_df_ang_h <- tar_read(tallo_reduced_lr_df_ang_h)

ang_data_h <- tallo_reduced_lr_df_ang_h |> filter(division == "Angiosperm")
gym_data_h <- tallo_reduced_lr_df_ang_h |> filter(division == "Gymnosperm")

ang_h_obs <- nrow(ang_data_h)
ang_h_sp <- ang_data_h |> distinct(sp) |> nrow()
ang_h_trait_ranges <- ang_data_h |> dplyr::select(dbh, h, wd) |> apply(2, range)

gym_h_obs <- nrow(gym_data_h)
gym_h_sp <- gym_data_h |> distinct(sp) |> nrow()
gym_h_trait_ranges <- gym_data_h |> dplyr::select(dbh, h, wd) |> apply(2, range)

# Read and process CR allometry sub-dataset
tallo_reduced_lr_df_ang_cr <- tar_read(tallo_reduced_lr_df_ang_cr)

ang_data_cr <- tallo_reduced_lr_df_ang_cr |> filter(division == "Angiosperm")
gym_data_cr <- tallo_reduced_lr_df_ang_cr |> filter(division == "Gymnosperm")

ang_cr_obs <- nrow(ang_data_cr)
ang_cr_sp <- ang_data_cr |> distinct(sp) |> nrow()
ang_cr_trait_ranges <- ang_data_cr |> dplyr::select(dbh, cr, wd) |> apply(2, range)

gym_cr_obs <- nrow(gym_data_cr)
gym_cr_sp <- gym_data_cr |> distinct(sp) |> nrow()
gym_cr_trait_ranges <- gym_data_cr |> dplyr::select(dbh, cr, wd) |> apply(2, range)

# Read and process DBH allometry sub-dataset
tallo_reduced_lr_df_ang_dbh <- tar_read(tallo_reduced_lr_df_ang_dbh)

ang_data_dbh <- tallo_reduced_lr_df_ang_dbh |>
  filter(division == "Angiosperm", !is.na(dbh), !is.na(cr), !is.na(h)) |>
  group_by(sp) |>
  filter(n() >= 20) |>
  ungroup()

gym_data_dbh <- tallo_reduced_lr_df_ang_dbh |>
  filter(division == "Gymnosperm", !is.na(dbh), !is.na(cr), !is.na(h)) |>
  group_by(sp) |>
  filter(n() >= 20) |>
  ungroup()

ang_dbh_obs <- nrow(ang_data_dbh)
ang_dbh_sp <- ang_data_dbh |> distinct(sp) |> nrow()
ang_dbh_trait_ranges <- ang_data_dbh |> dplyr::select(dbh, cr, h, wd) |> apply(2, range)

gym_dbh_obs <- nrow(gym_data_dbh)
gym_dbh_sp <- gym_data_dbh |> distinct(sp) |> nrow()
gym_dbh_trait_ranges <- gym_data_dbh |> dplyr::select(dbh, cr, h, wd) |> apply(2, range)

# Combine the data
combined_data <- tibble(
  `Dependent variables` = rep(c("H", "CR", "DBH"), each = 2),
  Division = rep(c("Angiosperm", "Gymnosperm"), times = 3),
  `Number of trees` = as.character(c(
    nrow(ang_data_h), nrow(gym_data_h),
    nrow(ang_data_cr), nrow(gym_data_cr),
    nrow(ang_data_dbh), nrow(gym_data_dbh)
  )),
  `Number of species` = as.character(c(
    ang_data_h |> distinct(sp) |> nrow(),
    gym_data_h |> distinct(sp) |> nrow(),
    ang_data_cr |> distinct(sp) |> nrow(),
    gym_data_cr |> distinct(sp) |> nrow(),
    ang_data_dbh |> distinct(sp) |> nrow(),
    gym_data_dbh |> distinct(sp) |> nrow()
  )),
  `DBH range` = c(
    range(ang_data_h$dbh) |> paste(collapse = " - "), range(gym_data_h$dbh) |> paste(collapse = " - "),
    range(ang_data_cr$dbh) |> paste(collapse = " - "), range(gym_data_cr$dbh) |> paste(collapse = " - "),
    range(ang_data_dbh$dbh) |> paste(collapse = " - "), range(gym_data_dbh$dbh) |> paste(collapse = " - ")
  ),
  `Dependent variable range` = c(
    range(ang_data_h$h) |> paste(collapse = " - "), range(gym_data_h$h) |> paste(collapse = " - "),
    range(ang_data_cr$cr) |> paste(collapse = " - "), range(gym_data_cr$cr) |> paste(collapse = " - "),
    range(ang_data_dbh$cr) |> paste(collapse = " - "), range(gym_data_dbh$cr) |> paste(collapse = " - ")
  ),
  `WD range` = c(
    ang_data_h$wd |> range(na.rm = TRUE) |> round(3) |> paste(collapse = " - "),
    gym_data_h$wd |> range(na.rm = TRUE) |> round(3) |> paste(collapse = " - "),
    ang_data_cr$wd |> range(na.rm = TRUE) |> round(3) |> paste(collapse = " - "),
    gym_data_cr$wd |> range(na.rm = TRUE) |> round(3) |> paste(collapse = " - "),
    ang_data_dbh$wd |> range(na.rm = TRUE) |> round(3) |> paste(collapse = " - "),
    gym_data_dbh$wd |> range(na.rm = TRUE) |> round(3) |> paste(collapse = " - ")
  ),
  Relationship = rep(c("H-DBH", "CR-DBH", "DBH-CR,H"), each = 2)
)

formatted_table <- combined_data |>
  pivot_longer(
    cols = c(`Number of trees`, `Number of species`, `DBH range`, `Dependent variable range`, `WD range`),
    names_to = "Characteristics",
    values_to = "Values"
  ) |>
  pivot_wider(
    names_from = Division,
    values_from = Values
  ) |>
  dplyr::select(`Dependent variables`, Characteristics, Relationship, Angiosperm, Gymnosperm)

formatted_table
```


> formatted_table
# A tibble: 15 × 5
   `Dependent variables` Characteristics          Relationship Angiosperm   Gymnosperm  
   <chr>                 <chr>                    <chr>        <chr>        <chr>       
 1 H                     Number of trees          H-DBH        79332        6306        
 2 H                     Number of species        H-DBH        1214         76          
 3 H                     DBH range                H-DBH        1 - 560      1 - 648     
 4 H                     Dependent variable range H-DBH        1.3 - 94     1.3 - 115.8 
 5 H                     WD range                 H-DBH        0.131 - 1.17 0.32 - 0.689
 6 CR                    Number of trees          CR-DBH       45350        4632        
 7 CR                    Number of species        CR-DBH       762          59          
 8 CR                    DBH range                CR-DBH       1 - 385      1 - 266     
 9 CR                    Dependent variable range CR-DBH       0.05 - 24.25 0.1 - 8.75  
10 CR                    WD range                 CR-DBH       0.131 - 1.15 0.32 - 0.689
11 DBH                   Number of trees          DBH-CR,H     41713        3685        
12 DBH                   Number of species        DBH-CR,H     744          56          
13 DBH                   DBH range                DBH-CR,H     1 - 385      1 - 266     
14 DBH                   Dependent variable range DBH-CR,H     0.1 - 24.25  0.2 - 10.65 
15 DBH                   WD range                 DBH-CR,H     0.131 - 1.15 0.32 - 0.651

```{r}
library(dplyr)
library(tidyr)
library(targets)

options(width = 150)
tallo_reduced_lr_df_ang_h <- tar_read(tallo_reduced_lr_df_ang_h)
tallo_reduced_lr_df_ang_cr <- tar_read(tallo_reduced_lr_df_ang_cr)
tallo_reduced_lr_df_ang_dbh <- tar_read(tallo_reduced_lr_df_ang_dbh)
tallo_reduced_lr_df_ang_dbh1 <- tar_read(tallo_reduced_lr_df_ang_dbh1)
tallo_reduced_lr_df_ang_dbh2 <- tar_read(tallo_reduced_lr_df_ang_dbh2)
tallo_reduced_lr_df_ang_dbh3 <- tar_read(tallo_reduced_lr_df_ang_dbh3)

ang_data_h <- tallo_reduced_lr_df_ang_h |> filter(division == "Angiosperm")
ang_data_h
summary(ang_data_h)

gym_data_h <- tallo_reduced_lr_df_ang_h |> filter(division == "Gymnosperm")
summary(gym_data_h)

# Process CR allometry dataset
ang_data_cr <- tallo_reduced_lr_df_ang_cr |> filter(division == "Angiosperm")
summary(ang_data_cr)

gym_data_cr <- tallo_reduced_lr_df_ang_cr |> filter(division == "Gymnosperm")
summary(gym_data_cr)

# Process DBH allometry datasets with specific filters
ang_data_dbh <- tallo_reduced_lr_df_ang_dbh |>
  filter(division == "Angiosperm", !is.na(dbh), !is.na(cr), !is.na(h)) |>
  group_by(sp) |> filter(n() >= 20) |>
  ungroup()

summary(ang_data_dbh)

gym_data_dbh <- tallo_reduced_lr_df_ang_dbh |>
  filter(division == "Gymnosperm", !is.na(dbh), !is.na(cr), !is.na(h)) |>
  group_by(sp) |> filter(n() >= 20) |>
  ungroup()

summary(gym_data_dbh)

ang_data_dbh1 <- tallo_reduced_lr_df_ang_dbh1 |>
  filter(division == "Angiosperm", !is.na(dbh), !is.na(cr), !is.na(h)) |>
  group_by(sp) |> filter(n() >= 20) |>
  ungroup()

summary(ang_data_dbh1)

gym_data_dbh1 <- tallo_reduced_lr_df_ang_dbh1 |>
  filter(division == "Gymnosperm", !is.na(dbh), !is.na(cr), !is.na(h)) |>
  group_by(sp) |> filter(n() >= 20) |>
  ungroup()

summary(gym_data_dbh1)

ang_data_dbh2 <- tallo_reduced_lr_df_ang_dbh2 |>
  filter(division == "Angiosperm", !is.na(dbh), !is.na(cr)) |>
  group_by(sp) |> filter(n() >= 20) |>
  ungroup()

summary(ang_data_dbh2)

gym_data_dbh2 <- tallo_reduced_lr_df_ang_dbh2 |>
  filter(division == "Gymnosperm", !is.na(dbh), !is.na(cr)) |>
  group_by(sp) |> filter(n() >= 20) |>
  ungroup()

summary(gym_data_dbh2)

ang_data_dbh3 <- tallo_reduced_lr_df_ang_dbh3 |>
  filter(division == "Angiosperm", !is.na(dbh), !is.na(h)) |>
  group_by(sp) |> filter(n() >= 20) |>
  ungroup()

summary(ang_data_dbh3)

gym_data_dbh3 <- tallo_reduced_lr_df_ang_dbh3 |>
  filter(division == "Gymnosperm", !is.na(dbh), !is.na(h)) |>
  group_by(sp) |> filter(n() >= 20) |>
  ungroup()

summary()



# Recreate `combined_data` with corrected Predictor variable range logic
combined_data <- tibble(
  `Dependent variables` = rep(c("H", "CR", "DBH", "DBH", "DBH", "DBH"), each = 2),
  `Predictor variable` = c(
    "DBH", "DBH", 
    "DBH", "DBH",
    "CR, H", "CR, H", 
    "CR * H", "CR * H", 
    "CR", "CR", 
    "H", "H"
  ),
  Division = rep(c("Angiosperm", "Gymnosperm"), times = 6),
  `Number of trees` = as.character(c(
    nrow(ang_data_h), nrow(gym_data_h),
    nrow(ang_data_cr), nrow(gym_data_cr),
    nrow(ang_data_dbh), nrow(gym_data_dbh),
    nrow(ang_data_dbh1), nrow(gym_data_dbh1),
    nrow(ang_data_dbh2), nrow(gym_data_dbh2),
    nrow(ang_data_dbh3), nrow(gym_data_dbh3)
  )),
  `Number of species` = as.character(c(
    ang_data_h |> distinct(sp) |> nrow(),
    gym_data_h |> distinct(sp) |> nrow(),
    ang_data_cr |> distinct(sp) |> nrow(),
    gym_data_cr |> distinct(sp) |> nrow(),
    ang_data_dbh |> distinct(sp) |> nrow(),
    gym_data_dbh |> distinct(sp) |> nrow(),
    ang_data_dbh1 |> distinct(sp) |> nrow(),
    gym_data_dbh1 |> distinct(sp) |> nrow(),
    ang_data_dbh2 |> distinct(sp) |> nrow(),
    gym_data_dbh2 |> distinct(sp) |> nrow(),
    ang_data_dbh3 |> distinct(sp) |> nrow(),
    gym_data_dbh3 |> distinct(sp) |> nrow()
  )),
  `Predictor variable range` = c(
    range(ang_data_h$dbh) |> paste(collapse = " - "), range(gym_data_h$dbh) |> paste(collapse = " - "),
    range(ang_data_cr$dbh) |> paste(collapse = " - "), range(gym_data_cr$dbh) |> paste(collapse = " - "),
    paste("CR:", range(ang_data_dbh$cr) |> paste(collapse = " - "), 
          "H:", range(ang_data_dbh$h) |> paste(collapse = " - "), sep = " "),
    paste("CR:", range(gym_data_dbh$cr) |> paste(collapse = " - "), 
          "H:", range(gym_data_dbh$h) |> paste(collapse = " - "), sep = " "),
    paste("CR:", range(ang_data_dbh1$cr) |> paste(collapse = " - "),
          "H:", range(ang_data_dbh1$h) |> paste(collapse = " - "), sep = " "),
    paste("CR:", range(gym_data_dbh1$cr) |> paste(collapse = " - "),
          "H:", range(gym_data_dbh1$h) |> paste(collapse = " - "), sep = " "),
    paste("CR:", range(ang_data_dbh2$cr) |> paste(collapse = " - ")),
    paste("CR:", range(gym_data_dbh2$cr) |> paste(collapse = " - ")),
    paste("H:", range(ang_data_dbh3$h) |> paste(collapse = " - ")),
    paste("H:", range(gym_data_dbh3$h) |> paste(collapse = " - "))
  ),
  `Dependent variable range` = c(
    range(ang_data_h$h) |> paste(collapse = " - "), range(gym_data_h$h) |> paste(collapse = " - "),
    range(ang_data_cr$cr) |> paste(collapse = " - "), range(gym_data_cr$cr) |> paste(collapse = " - "),
    range(ang_data_dbh$cr) |> paste(collapse = " - "), range(gym_data_dbh$cr) |> paste(collapse = " - "),
    range(ang_data_dbh1$cr) |> paste(collapse = " - "), range(gym_data_dbh1$cr) |> paste(collapse = " - "),
    range(ang_data_dbh2$cr) |> paste(collapse = " - "), range(gym_data_dbh2$cr) |> paste(collapse = " - "),
    range(ang_data_dbh3$h) |> paste(collapse = " - "), range(gym_data_dbh3$h) |> paste(collapse = " - ")
  ),
  `WD range` = c(
    ang_data_h$wd |> range(na.rm = TRUE) |> round(3) |> paste(collapse = " - "),
    gym_data_h$wd |> range(na.rm = TRUE) |> round(3) |> paste(collapse = " - "),
    ang_data_cr$wd |> range(na.rm = TRUE) |> round(3) |> paste(collapse = " - "),
    gym_data_cr$wd |> range(na.rm = TRUE) |> round(3) |> paste(collapse = " - "),
    ang_data_dbh$wd |> range(na.rm = TRUE) |> round(3) |> paste(collapse = " - "),
    gym_data_dbh$wd |> range(na.rm = TRUE) |> round(3) |> paste(collapse = " - "),
    ang_data_dbh1$wd |> range(na.rm = TRUE) |> round(3) |> paste(collapse = " - "),
    gym_data_dbh1$wd |> range(na.rm = TRUE) |> round(3) |> paste(collapse = " - "),
    ang_data_dbh2$wd |> range(na.rm = TRUE) |> round(3) |> paste(collapse = " - "),
    gym_data_dbh2$wd |> range(na.rm = TRUE) |> round(3) |> paste(collapse = " - "),
    ang_data_dbh3$wd |> range(na.rm = TRUE) |> round(3) |> paste(collapse = " - "),
    gym_data_dbh3$wd |> range(na.rm = TRUE) |> round(3) |> paste(collapse = " - ")
  )
)
combined_data

formatted_table <- combined_data |>
  pivot_longer(
    cols = c(`Number of trees`, `Number of species`, `Predictor variable range`, `Dependent variable range`, `WD range`),
    names_to = "Characteristics",
    values_to = "Values"
  ) |>
  pivot_wider(
    names_from = Division,
    values_from = Values
  ) |>
  dplyr::select(`Dependent variables`, `Predictor variable`, Characteristics, Angiosperm, Gymnosperm)

print(formatted_table, n = Inf)
```


# Checking species-specific posterior

```{r}
options(width = 200)
sp_posterior_df_rounded <- tar_read(sp_posterior_df_rounded)
head(sp_posterior_df_rounded)
summary(sp_posterior_df_rounded)


# h_posterior_df <- sp_posterior_df_rounded |>
#   filter(Dependent_variable == "Tree Height") |>
#   dplyr::select(sp, Division, Dependent_variable, a, b, k)

h_posterior_df <- sp_posterior_df_rounded |>
  dplyr::select(sp, Division, Dependent_variable, a, b, k) |>
  filter(
    Dependent_variable == "Tree Height",
    !is.na(a),
    !is.na(b),
    !is.na(k)
  )

head(h_posterior_df)
summary(h_posterior_df)
length(unique(h_posterior_df$sp))

h_ang <- h_posterior_df |>
  filter(Division == "Angiosperm")
head(h_ang)


summary(h_ang)
length(unique(h_ang$sp))

h_gym <- h_posterior_df |>
  filter(Division == "Gymnosperm")
h_gym






```

```{r}
options(width = 200)
sp_posterior_df <- tar_read(sp_posterior_df)
head(sp_posterior_df)
summary(sp_posterior_df)


# h_posterior_df <- sp_posterior_df_rounded |>
#   filter(Dependent_variable == "Tree Height") |>
#   dplyr::select(sp, Division, Dependent_variable, a, b, k)

h_posterior_df <- sp_posterior_df |>
  dplyr::select(sp, Division, Dependent_variable, a, b, k) |>
  filter(
    Dependent_variable == "Tree Height",
    !is.na(a),
    !is.na(b),
    !is.na(k)
  )

head(h_posterior_df)
summary(h_posterior_df)
length(unique(h_posterior_df$sp))

```

# Check H, CR data

```{r}
options(width = 150)
tallo_reduced_lr_df_ang_h <- tar_read(tallo_reduced_lr_df_ang_h)
tallo_reduced_lr_df_ang_h

ang_lr <- tallo_reduced_lr_df_ang_h |>
   filter(division == "Angiosperm")
ang_lr

gym_lr <- tallo_reduced_lr_df_ang_h |>
   filter(division == "Gymnosperm")
gym_lr

tallo_reduced_lr_df_ang_h <- tar_read(tallo_reduced_lr_df_ang_h)
tallo_reduced_lr_df_ang_h

ang_nlr <- tallo_reduced_lr_df_ang_h |>
   filter(division == "Angiosperm")
ang_nlr

gym_nlr <- tallo_reduced_lr_df_ang_h |>
   filter(division == "Gymnosperm")


```


## CHECKING DATA

```{r}
# Angiosperm datasets
fit_nlr_nou_summary_weibull_ang_h <- tar_read(fit_nlr_nou_summary_weibull_ang_h)
fit_lr_nou_summary_pl_ang_h <- tar_read(fit_lr_nou_summary_pl_ang_h)
fit_lr_nou_summary_pl_ang_dbh <- tar_read(fit_lr_nou_summary_pl_ang_dbh)
fit_lr_nou_summary_pl_ang_dbh1 <- tar_read(fit_lr_nou_summary_pl_ang_dbh1)
fit_lr_nou_summary_pl_ang_dbh2 <- tar_read(fit_lr_nou_summary_pl_ang_dbh2)
fit_lr_nou_summary_pl_ang_dbh3 <- tar_read(fit_lr_nou_summary_pl_ang_dbh3)
tallo_reduced_nlr_df_ang_h <- tar_read(tallo_reduced_nlr_df_ang_h)
tallo_reduced_lr_df_ang_h <- tar_read(tallo_reduced_lr_df_ang_h)
tallo_reduced_lr_df_ang_dbh <- tar_read(tallo_reduced_lr_df_ang_dbh)
tallo_reduced_lr_df_ang_dbh1 <- tar_read(tallo_reduced_lr_df_ang_dbh1)
tallo_reduced_lr_df_ang_dbh2 <- tar_read(tallo_reduced_lr_df_ang_dbh2)
tallo_reduced_lr_df_ang_dbh3 <- tar_read(tallo_reduced_lr_df_ang_dbh3)
stan_data_nlr_ang_h <- tar_read(stan_data_nlr_ang_h)
stan_data_lr_ang_h <- tar_read(stan_data_lr_ang_h)
stan_data_lr_ang_dbh <- tar_read(stan_data_lr_ang_dbh)
stan_data_lr_ang_dbh1 <- tar_read(stan_data_lr_ang_dbh1)
stan_data_lr_ang_dbh2 <- tar_read(stan_data_lr_ang_dbh2)
stan_data_lr_ang_dbh3 <- tar_read(stan_data_lr_ang_dbh3)

# Gymnosperm datasets
fit_nlr_nou_summary_weibull_gym_h <- tar_read(fit_nlr_nou_summary_weibull_gym_h)
fit_lr_nou_summary_pl_gym_h <- tar_read(fit_lr_nou_summary_pl_gym_h)
fit_lr_nou_summary_pl_gym_dbh <- tar_read(fit_lr_nou_summary_pl_gym_dbh)
fit_lr_nou_summary_pl_gym_dbh1 <- tar_read(fit_lr_nou_summary_pl_gym_dbh1)
fit_lr_nou_summary_pl_gym_dbh2 <- tar_read(fit_lr_nou_summary_pl_gym_dbh2)
fit_lr_nou_summary_pl_gym_dbh3 <- tar_read(fit_lr_nou_summary_pl_gym_dbh3)
tallo_reduced_nlr_df_gym_h <- tar_read(tallo_reduced_nlr_df_gym_h)
tallo_reduced_lr_df_gym_h <- tar_read(tallo_reduced_lr_df_gym_h)
tallo_reduced_lr_df_gym_dbh <- tar_read(tallo_reduced_lr_df_gym_dbh)
tallo_reduced_lr_df_gym_dbh1 <- tar_read(tallo_reduced_lr_df_gym_dbh1)
tallo_reduced_lr_df_gym_dbh2 <- tar_read(tallo_reduced_lr_df_gym_dbh2)
tallo_reduced_lr_df_gym_dbh3 <- tar_read(tallo_reduced_lr_df_gym_dbh3)
stan_data_nlr_gym_h <- tar_read(stan_data_nlr_gym_h)
stan_data_lr_gym_h <- tar_read(stan_data_lr_gym_h)
stan_data_lr_gym_dbh <- tar_read(stan_data_lr_gym_dbh)
stan_data_lr_gym_dbh1 <- tar_read(stan_data_lr_gym_dbh1)
stan_data_lr_gym_dbh2 <- tar_read(stan_data_lr_gym_dbh2)
stan_data_lr_gym_dbh3 <- tar_read(stan_data_lr_gym_dbh3)

tallo_reduced_lr_df_ang_dbh
tallo_reduced_lr_df_gym_dbh

ang_data_dbh <- tallo_reduced_lr_df_ang_dbh |>
  filter(division == "Angiosperm", !is.na(dbh), !is.na(cr), !is.na(h)) |>
  group_by(sp) |> filter(n() >= 20) |>
  ungroup()

ang_data_dbh
length(unique(ang_data_dbh$sp))
str(stan_data_lr_ang_dbh)

gym_data_dbh <- tallo_reduced_lr_df_gym_dbh |>
  filter(division == "Gymnosperm", !is.na(dbh), !is.na(cr), !is.na(h)) |>
  group_by(sp) |> filter(n() >= 20) |>
  ungroup()
gym_data_dbh
length(unique(gym_data_dbh$sp))
str(stan_data_lr_gym_dbh)

tallo_reduced_lr_df_ang_dbh1
tallo_reduced_lr_df_gym_dbh1

ang_data_dbh1 <- tallo_reduced_lr_df_ang_dbh1 |>
  filter(division == "Angiosperm", !is.na(dbh), !is.na(cr), !is.na(h)) |>
  group_by(sp) |> filter(n() >= 20) |>
  ungroup()
ang_data_dbh1
length(unique(ang_data_dbh1$sp))
str(stan_data_lr_ang_dbh1)


gym_data_dbh1 <- tallo_reduced_lr_df_gym_dbh1 |>
  filter(division == "Gymnosperm", !is.na(dbh), !is.na(cr), !is.na(h)) |>
  group_by(sp) |> filter(n() >= 20) |>
  ungroup()

gym_data_dbh1
length(unique(gym_data_dbh1$sp))
str(stan_data_lr_gym_dbh1)


ang_data_dbh2 <- tallo_reduced_lr_df_ang_dbh2 |>
  filter(division == "Angiosperm", !is.na(dbh), !is.na(cr), !is.na(h)) |>
  group_by(sp) |> filter(n() >= 20) |>
  ungroup()

ang_data_dbh2
length(unique(ang_data_dbh2$sp))
str(stan_data_lr_ang_dbh2)


gym_data_dbh2 <- tallo_reduced_lr_df_gym_dbh2 |>
  filter(division == "Gymnosperm", !is.na(dbh), !is.na(cr), !is.na(h)) |>
  group_by(sp) |> filter(n() >= 20) |>
  ungroup()

gym_data_dbh2
length(unique(gym_data_dbh2$sp))
str(stan_data_lr_gym_dbh2)

ang_data_dbh3 <- tallo_reduced_lr_df_ang_dbh3 |>
  filter(division == "Angiosperm", !is.na(dbh), !is.na(h), !is.na(cr)) |>
  group_by(sp) |> filter(n() >= 20) |>
  ungroup()
ang_data_dbh3
length(unique(ang_data_dbh3$sp))

str(stan_data_lr_ang_dbh3)


gym_data_dbh3 <- tallo_reduced_lr_df_gym_dbh3 |>
  filter(division == "Gymnosperm", !is.na(dbh), !is.na(h), !is.na(cr)) |>
  group_by(sp) |> filter(n() >= 20) |>
  ungroup()

gym_data_dbh3
length(unique(gym_data_dbh3$sp))

str(stan_data_lr_gym_dbh3)


```

```{r}
tallo_reduced_lr_df_ang_h <- tar_read(tallo_reduced_lr_df_ang_h)
tallo_reduced_lr_df_ang_h

ang_data_h <- tallo_reduced_lr_df_ang_h |> filter(division == "Angiosperm") |>
  group_by(sp) |>
  summarise(count = n()) |>
  filter(count >= 20)

ang_h_sp

gym_data_h <- tallo_reduced_lr_df_ang_h |> filter(division == "Gymnosperm") |>
  group_by(sp) |>
  summarise(count = n()) |>
  filter(count >= 20)
gym_data_h

```