---
title: "The relationships between tree architecture and wood density"
author: "Nguyen Thi Duyen"
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontsize: 12pt
format:
  html:
    theme: cosmo
    toc: true
    toc-depth: 2
    number-sections: true
    smooth-scroll: true
    standalone: true
    embed-resources: true
---

```{r global_options, include=FALSE}
library(knitr)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  cache = FALSE,
  fig.align = "center",
  fig.show = "hold"
)
```

# Load the packages
```{r}
library(readr)
library(tidyverse)
library(here)
library(lme4)
library(e1071)
library(car)
library(sjPlot)
library(gridExtra)
```

# Data preparation
```{r}
tallo_df <- read_csv(here("data/tallo_cleaned.csv"))
tallo_df
```

```{r}
wd_df <- read_csv(here("data/wd.csv"))
wd_df <- wd_df |>
  mutate(wd_s = scale(wd) |> as.numeric())
wd_df
```

## Join tallo and wood density dataframe
```{r}
tallo_wd <- left_join(tallo_df, wd_df, by = "sp")
tallo_wd
```

## Data transformation
```{r}
tallo_wd$dbh_ln <- log(tallo_wd$dbh)
tallo_wd$cr_ln <- log(tallo_wd$cr)
tallo_wd$h_ln <- log(tallo_wd$h)
tallo_wd
```

```{r}
wd_s_numeric <- as.numeric(tallo_wd$wd_s)
dbh_ln_numeric <- as.numeric(tallo_wd$dbh_ln)
h_ln_numeric <- as.numeric(tallo_wd$h_ln)
cr_ln_numeric <- as.numeric(tallo_wd$cr_ln)
str(tallo_wd)
```

# Fitting lme4::lmer

## Scatter plot
```{r}
scatter_h_dbh <- ggplot(tallo_wd, aes(x = dbh_ln, y = h_ln)) +
  geom_point(color = "skyblue") +
  geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
  labs(x = "Log(dbh)", y = "Log(h)", title = "Scatter Plot of Log(dbh) vs Log(h)")

scatter_cr_dbh <- ggplot(tallo_wd, aes(x = dbh_ln, y = cr_ln)) +
  geom_point(color = "skyblue") +
  geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
  labs(x = "Log(dbh)", y = "Log(cr)", title = "Scatter Plot of Log(dbh) vs Log(cr)")

scatter_dbh_hcr <- ggplot(tallo_wd, aes(x = h_ln + cr_ln, y = dbh_ln)) +
  geom_point(color = "skyblue") +
  geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
  labs(x = "Log(h) + Log(cr)", y = "Log(dbh)", title = "Scatter Plot of Log(h) + Log(cr) vs Log(dbh)")

scatter_h_dbh 
scatter_cr_dbh
scatter_dbh_hcr
```

## Fitting models (lmer)
```{r}
dhcmod1 <- lme4::lmer(dbh_ln ~ (h_ln + cr_ln) + wd_s + (h_ln + cr_ln):wd_s + (1 + (h_ln + cr_ln) | sp), data = tallo_wd)
hdmod1 <- lme4::lmer(h_ln ~ dbh_ln + wd_s + dbh_ln:wd_s + (1 + dbh_ln | sp), data = tallo_wd)
cdmod1 <- lme4::lmer(cr_ln ~ dbh_ln + wd_s + dbh_ln:wd_s + (1 + dbh_ln | sp), data = tallo_wd)
```

```{r}
summary(hdmod1)
summary(cdmod1)
summary(dhcmod1)
```

```{r}
plot(dhcmod1)
plot(hdmod1)
plot(cdmod1)
```

## Key findings
- hdmod1: 
The t-value of wd_s is 2.110. This t-value indicates the significant positive effect of coefficiect estimate for wd_s on h_ln.
The t-values of dbh_ln:wd_s is -5.182, which indicates that the interaction between dbh_ln and wd_s has a significant negative effect on h_ln.
- cdmod1: The t-value associated with wd_s is 3.819. This t-value indicates the significance of wd_s.
On the other hand, the interaction between dbh_ln and wd_s does not have a significant effect in cr_ln in this model.
- dhcmod1: The t-value associated with wd_s is -1.982, suggesting that wd_s has a negative effect on dbh_ln (but it is not statistically significant at conventional levels with p > 0.05).
Hence, in this model, neither wd_s nor its interations with h_ln or cr_ln have statistically significant effects on dbh_ln.