---
title: "Overlaps species"
author: "Nguyen Thi Duyen"
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontsize: 12pt
format:
  html:
    theme: cosmo
    toc: true
    toc-depth: 2
    number-sections: true
    smooth-scroll: true
    standalone: true
    embed-resources: true
---

```{r global_options, include=FALSE}
library(knitr)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  cache = FALSE,
  fig.align = "center",
  fig.show = "hold"
)
```

```{r}
library(readr)
library(tidyverse)
library(tidyr)
library(here)
library(dplyr)
```

# Preparation of data

- tallo with allometric variables (h, dbh, cr)

```{r}
allo <- read_csv(here("data-raw/Tallo.csv"))
```

- "try" with wood density for each species

```{r}
wood <- read_csv(here("data/try.csv"))
wood[1:5]
```

# Cleaning data
- tallo

```{r}
selected_data <- allo %>%
  select(sp = species, dbh = stem_diameter_cm, h = height_m, cr = crown_radius_m)
write_csv(selected_data, "data/allo.csv")
```

- try

```{r}
selected_data <- wood %>%
  select(sp = AccSpeciesName, wd = OrigValueStr, unit = OrigUnitStr)
write_csv(selected_data, "data/wd.csv")
wd <- separate(wd, sp.wd., into = c("sp", "wd", "unit"), sep = ";")
wd1 <- read_csv("data/wd.csv")
str(wd1)
head(wd1, n=5) 
```

- filter
```{r}
allo2 <- read_csv("data/allo.csv")
wood2 <- read_csv("data/wd.csv")
allo3 <- allo2 %>%
  filter(!is.na(sp) & sp != "unknown" & !is.na(dbh) & !is.na(h) & !is.na(cr))

wood3 <- wood2 %>%
  filter(!is.na(sp) & sp != "unknown" & !is.na(wd) & !is.na(unit))

write_csv(allo3, "data/allo_cleaned.csv")
write_csv(wood3, "data/wd_cleaned.csv")

```

- checking for the overlap (2209 species)
```{r}
allo_cleaned <- read_csv("data/allo_cleaned.csv")
wd_cleaned <- read_csv("data/wd_cleaned.csv")
allo_species <- unique(allo_cleaned$sp)
wd_species <- unique(wd_cleaned$sp)
overlap_sp <- intersect(allo_species, wd_species)
cat("Overlapping species:\n")
print(overlap_sp)
overlap_sp
```

- cleaning wd_cleaned.csv data
```{r}
wd2<- read_csv("data/wd_cleaned.csv")
table(wd2$unit)
```

- chosing units
```{r}
print(wd2)
```

```{r}
selected_units <- c("(g/cm3)*100", "g /(cm3*10)", "g*cm-3", "g/dm3", "gr/cm3", "kg/m3", "mg/mm^3", 
                    "t/m3", "cm3/mg", "g / cm3", "g cm-3", "g/cm^3", "g\xb7cm-3", "mg mm-3", 
                    "mg/mm3", "g / ml", "g_cm3-1", "g/cm3", "mg / mm3", "mg/cm3", "t m3", "kg m-3")
```

```{r}
wd3 <- wd2[wd2$unit %in% selected_units, ]
write_csv(wd3, "data/wd_unit.csv")
head(wd3, 6)
summary(wd3)
wd3$wd <- as.numeric(wd3$wd)
```

- convert units to g/cm^3
```{r}
conversion_factors <- c(`(g/cm3)*100` = 1 / 100, 
                        `g /(cm3*10)` = 1 / 10, 
                        `g*cm-3` = 1 , 
                        `g/dm3` = 1 / 1000, 
                        `gr/cm3` = 1, 
                        `kg/m3` = 1 / 1000, 
                        `mg/mm^3` = 1, 
                        `t/m3` = 1 , 
                        `cm3/mg` = 1 / (1 * 1000), 
                        `g / cm3` = 1, 
                        `g cm-3` = 1, 
                        `g/cm^3` = 1, 
                        `g\xb7cm-3` = 1, 
                        `mg mm-3` = 1 , 
                        `mg/mm3` = 1 , 
                        `g / ml` = 1 , 
                        `g_cm3-1` = 1, 
                        `g/cm3` = 1, 
                        `mg / mm3` = 1 , 
                        `mg/cm3` = 1 / (1 * 1000), 
                        `t m3` = 1 ,
                        `kg m-3` = 1 / 1000)
```

```{r}
wd3$wd_convert <- wd3$wd * conversion_factors[as.character(wd3$unit)]
```

```{r}
wd4 <- wd3[, c("sp", "wd_convert")]
colnames(wd4) <- c("sp", "wd_converted")  # Rename the columns
write.csv(wd4, "data/wd_convert.csv", row.names = FALSE)
summary(wd4)
```

# Checking after converting
```{r}
wd_filtered <- wd4 %>% 
  filter(wd_convert > 0.2 & wd_convert <= 1.2)
write.csv(wd_filtered, "data/wd_converted.csv", row.names = FALSE)
wd5 <- read_csv("data/wd_converted.csv")
head(wd5, 6)
```


- checking overlap species (2208)
```{r}
allo4 <- read_csv("data/allo_cleaned.csv")
wd6 <- read_csv("data/wd_converted.csv")
species_allo4 <- unique(allo4$sp)
species_wd6 <- unique(wd6$sp)
overlapping_species <- intersect(species_allo4, species_wd6)
overlapping_species
```




# Join wd data with tallo allometry data (my macbook can not torelate)

```{r}
allo_wd <- left_join(allo4, wd6, by = "sp")
head(allo_wd, 3)
```

- write the data to a csv file
```{r}
write_csv(allo_wd, "data/overlap.csv")
```

- checking
```{r}
ov1 <- read_csv("data/overlap.csv")
summary(ov1)
head(ov1, 20)
```