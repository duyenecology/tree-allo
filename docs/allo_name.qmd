---
title: "Allometry name matching"
author: "Masatoshi Katabuchi"
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontsize: 12pt
format:
  html:
    theme: cosmo
    toc: true
    toc-depth: 2
    number-sections: true
    smooth-scroll: true
    standalone: true
    embed-resources: true
---

```{r global_options, include=FALSE}
library(knitr)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  cache = FALSE,
  fig.align = "center",
  fig.show = "hold"
)
```

```{r}
library(tidyverse)
library(here)
```

- species list with no c_name

```{r}
sp_list <- read_csv(here("data-raw/bb_sp_list.csv")) |>
  janitor::clean_names()

sp_list
```

- species list with c_name

```{r}
abund <- read_csv(here("data-raw/abund_xtbg.csv")) |>
  janitor::clean_names()

abund
```
- We just keep `cname`, `sp`, and `life` columns.

```{r}
abund <- abund |> dplyr::select(cname, sp, life)
```

- allometry with c_name

```{r}
allo <- read_csv(here("data-raw/bb_allometry.csv")) |>
  janitor::clean_names()

allo
```

- Join allometry data with abundance data on common species names

```{r}
allo_re <- left_join(allo, abund, by = c("sp_cn" = "cname"))

allo_re
```
-  Filter the joined dataset to find entries with missing species names

```{r}
allo_re  |>
  filter(is.na(sp))
```

```{r}
allo_re  |>
  filter(is.na(sp)) |>
  pull(sp_cn)
```

```{r}
abund |>
  filter(str_detect(cname, "橄榄"))
```

橄榄 in `allo` seems to be 橄榄 sp. (`CANATO`) in `abund`.
So, we add `CANATO` to `sp` if `sp_cn` is 橄榄.

```{r}
allo_re2  <- allo_re  |>
  mutate(sp = ifelse(sp_cn == "橄榄", "CANATO", sp))

allo_re2 |>
  filter(is.na(sp))
```

Now, only 33 data points are missing species names.
We can just ignore these data when we do the analysis.

- Write the data to a csv file.
```{r}
allo_re2 |>
  write_csv(here("data/bb_allometry_re.csv"))
```

I thought we had to edit these data manually, but it seems that we don't have to.
